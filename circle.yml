machine:
  environment:
    AZ_STATE_STORAGE_ACCOUNT_NAME: redapt
    AZ_STATE_CONTAINER_NAME: terraform-state
    AZ_STATE_KEY: terraform.tfstate
    # AZ_STATE_ACCESS_KEY: (Populated by circleci project env vars.)
    TERRAFORM_VER: 0.8.8
    PATH: $PATH:$HOME/.local/bin:$HOME/bin
  cache_directories:
    - ~/.local/bin
dependencies:
  override:
    - |
      if [[ ! -f ~/.local/bin/terraform ]]; then
        mkdir -p ~/.local/bin
        cd ~/.local/bin
        wget "https://releases.hashicorp.com/terraform/${TERRAFORM_VER}/terraform_${TERRAFORM_VER}_linux_amd64.zip"
        unzip *.zip
        rm *.zip
      fi
test:
  override:
    # (AZ_ vars come from circleci project env vars)
    - echo "az_subscription_id = \"$AZ_SUBSCRIPTION_ID\"" >> secret.tfvars
    - echo "az_client_id = \"$AZ_CLIENT_ID\"" >> secret.tfvars
    - echo "az_client_secret = \"$AZ_CLIENT_SECRET\"" >> secret.tfvars
    - echo "az_tenant_id = \"$AZ_TENANT_ID\"" >> secret.tfvars
    - bash _ci_remote_enable.sh
    - bash plan.sh
deployment:
  master:
    branch: master
    commands:
      - bash apply.sh